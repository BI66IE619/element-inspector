<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirrorInspect Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #18181b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        /* Ensure the code block actually shows colors */
        #codeBlock { background: transparent !important; }
        .diff-flash { animation: flash 0.4s ease-out; }
        @keyframes flash {
            0% { border-color: #3b82f6; box-shadow: 0 0 10px #3b82f6; }
            100% { border-color: #27272a; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-[#0a0a0a] text-zinc-300 h-screen flex flex-col overflow-hidden">

    <nav class="h-14 border-b border-zinc-800 bg-[#0f0f0f] flex items-center px-4 gap-4">
        <div class="font-bold text-white flex items-center gap-2">
            <span class="text-blue-500">â—ˆ</span> MirrorInspect <span class="text-[10px] bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">V2</span>
        </div>
        <input id="urlInput" type="text" placeholder="https://example.com" 
               class="flex-1 bg-zinc-900 border border-zinc-700 rounded-md px-3 py-1.5 text-sm outline-none focus:ring-1 focus:ring-blue-500 transition-all">
        <button onclick="runLoader()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-1.5 rounded-md text-sm font-medium transition-colors">Inspect</button>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <section class="w-1/2 flex flex-col">
            <div class="bg-[#151515] px-3 py-1 text-[10px] font-bold uppercase tracking-wider text-zinc-500 border-b border-zinc-800">Preview</div>
            <iframe id="displayFrame" class="w-full h-full bg-white shadow-inner"></iframe>
        </section>

        <section class="w-1/2 flex flex-col border-l border-zinc-800">
            <div id="codeHeader" class="bg-[#151515] px-3 py-1 text-[10px] font-bold uppercase tracking-wider text-zinc-500 border-b border-zinc-800 flex justify-between items-center">
                <span>Live DOM Elements</span>
                <div class="flex gap-4 items-center">
                    <span id="diffStatus" class="text-blue-400 font-mono text-[9px]"></span>
                    <span id="status" class="text-zinc-400 font-mono">READY</span>
                </div>
            </div>
            <div id="codeContainer" class="flex-1 overflow-auto bg-[#121212] p-4 custom-scrollbar">
                <pre><code id="codeBlock" class="language-html">Waiting for content...</code></pre>
            </div>
        </section>
    </main>

    <script>
        let lastHtml = "";

        async function runLoader(forcedUrl = null) {
            const input = forcedUrl || document.getElementById('urlInput').value.trim();
            if (!input) return;

            if(forcedUrl) document.getElementById('urlInput').value = forcedUrl;
            const frame = document.getElementById('displayFrame');
            const url = input.startsWith('http') ? input : `https://${input}`;
            
            document.getElementById('status').textContent = "FETCHING";

            try {
                const response = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                let html = await response.text();

                const baseTag = `<base href="${url}">`;
                const spyScript = `
                <script>
                    const sync = () => {
                        window.parent.postMessage({ 
                            type: 'dom-update', 
                            html: document.documentElement.outerHTML 
                        }, '*');
                    };
                    const obs = new MutationObserver(sync);
                    obs.observe(document.documentElement, { attributes: true, childList: true, subtree: true, characterData: true });
                    document.addEventListener('click', (e) => {
                        const a = e.target.closest('a');
                        if (a && a.href && !a.href.startsWith('javascript')) {
                            e.preventDefault();
                            window.parent.postMessage({ type: 'navigate', url: a.href }, '*');
                        }
                    }, true);
                    window.onload = sync;
                <\/script>`;

                html = html.replace('<head>', '<head>' + baseTag).replace('</body>', spyScript + '</body>');
                frame.srcdoc = html;
                document.getElementById('status').textContent = "LIVE";
            } catch (err) {
                document.getElementById('status').textContent = "ERROR";
            }
        }

        window.addEventListener('message', (event) => {
            if (event.data.type === 'dom-update') {
                const newHtml = event.data.html;
                const codeBlock = document.getElementById('codeBlock');
                const diffStatus = document.getElementById('diffStatus');

                if (newHtml !== lastHtml) {
                    lastHtml = newHtml;
                    
                    // 1. Inject raw text
                    codeBlock.textContent = newHtml;

                    // 2. FORCE HIGHLIGHTING (This fixes the "grey" issue)
                    delete codeBlock.dataset.highlighted; 
                    hljs.highlightElement(codeBlock);

                    // 3. UI Updates
                    diffStatus.textContent = "SYNCED: " + new Date().toLocaleTimeString();
                    const container = document.getElementById('codeContainer');
                    container.classList.remove('diff-flash');
                    void container.offsetWidth; 
                    container.classList.add('diff-flash');
                }
            }
            if (event.data.type === 'navigate') runLoader(event.data.url);
        });

        document.getElementById('urlInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') runLoader(); });
    </script>
</body>
</html>
